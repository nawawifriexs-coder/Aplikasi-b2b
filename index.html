<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi B2B Commercial</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--secondary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav li {
            margin-left: 20px;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav a:hover, nav a.active {
            background-color: var(--primary);
        }
        
        .auth-section {
            display: flex;
            align-items: center;
        }
        
        .user-info {
            margin-right: 15px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1, h2, h3 {
            margin-bottom: 15px;
            color: var(--secondary);
        }
        
        form {
            display: flex;
            flex-direction: column;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .hidden {
            display: none !important;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .order-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .order-item input, .order-item select {
            flex: 1;
        }
        
        .order-item .remove-btn {
            flex: 0 0 40px;
            background-color: var(--danger);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
        }
        
        .upload-area i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 10px;
        }
        
        .print-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card h3 {
            color: var(--secondary);
            margin-bottom: 10px;
        }
        
        .summary-card p {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            nav ul {
                margin-top: 15px;
                flex-wrap: wrap;
            }
            
            nav li {
                margin: 5px;
            }
            
            .auth-section {
                margin-top: 15px;
                width: 100%;
                justify-content: space-between;
            }
            
            .order-item {
                flex-wrap: wrap;
            }
            
            .order-item input, .order-item select {
                flex: 1 1 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <header class="hidden" id="mainHeader">
        <div class="container">
            <div class="header-content">
                <div class="logo">B2B Commercial</div>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active" data-page="dashboard">Dashboard</a></li>
                        <li><a href="#" class="nav-link" data-page="stock">Kelola Stok</a></li>
                        <li><a href="#" class="nav-link" data-page="warung">Data Warung</a></li>
                        <li><a href="#" class="nav-link" data-page="karyawan">Data Karyawan</a></li>
                        <li><a href="#" class="nav-link" data-page="order">Pemesanan</a></li>
                        <li><a href="#" class="nav-link" data-page="laporan">Laporan</a></li>
                    </ul>
                </nav>
                <div class="auth-section">
                    <div class="user-info" id="userInfo"></div>
                    <button id="logoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Halaman Login -->
        <div id="loginPage" class="page active">
            <div class="login-container">
                <h2>Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit">Login</button>
                </form>
                <div id="loginMessage" class="alert hidden"></div>
            </div>
        </div>

        <!-- Halaman Dashboard -->
        <div id="dashboardPage" class="page">
            <h1>Dashboard</h1>
            <div class="card">
                <h2>Ringkasan</h2>
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Total Produk</h3>
                        <p id="totalProducts">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Total Warung</h3>
                        <p id="totalWarungs">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Total Karyawan</h3>
                        <p id="totalKaryawans">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Total Pesanan</h3>
                        <p id="totalOrders">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Halaman Kelola Stok -->
        <div id="stockPage" class="page">
            <h1>Kelola Stok</h1>
            <div class="card">
                <h2>Upload Data Stok</h2>
                <div class="upload-area" id="stockUploadArea">
                    <i>📁</i>
                    <p>Klik atau seret file CSV/Excel di sini</p>
                    <input type="file" id="stockFile" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
                <button id="uploadStockBtn" class="btn-success">Upload Stok</button>
                <div id="stockUploadMessage" class="alert hidden"></div>
            </div>
            
            <div class="card">
                <h2>Daftar Stok</h2>
                <div class="action-buttons">
                    <button id="printStockBtn" class="btn-success">Cetak Stok (Excel)</button>
                </div>
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th>Barcode</th>
                            <th>Nama Barang</th>
                            <th>Stok</th>
                            <th>Harga</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <!-- Data stok akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Halaman Data Warung -->
        <div id="warungPage" class="page">
            <h1>Data Warung</h1>
            <div class="card">
                <h2>Tambah Data Warung</h2>
                <div class="upload-area" id="warungUploadArea">
                    <i>📁</i>
                    <p>Klik atau seret file CSV/Excel di sini</p>
                    <input type="file" id="warungFile" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
                <button id="uploadWarungBtn" class="btn-success">Upload Data Warung</button>
                <div id="warungUploadMessage" class="alert hidden"></div>
            </div>
            
            <div class="card">
                <h2>Daftar Warung</h2>
                <table id="warungTable">
                    <thead>
                        <tr>
                            <th>Nama Warung</th>
                            <th>Telepon</th>
                            <th>Alamat</th>
                        </tr>
                    </thead>
                    <tbody id="warungTableBody">
                        <!-- Data warung akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Halaman Data Karyawan -->
        <div id="karyawanPage" class="page">
            <h1>Data Karyawan</h1>
            <div class="card">
                <h2>Tambah Data Karyawan</h2>
                <div class="upload-area" id="karyawanUploadArea">
                    <i>📁</i>
                    <p>Klik atau seret file CSV/Excel di sini</p>
                    <input type="file" id="karyawanFile" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
                <button id="uploadKaryawanBtn" class="btn-success">Upload Data Karyawan</button>
                <div id="karyawanUploadMessage" class="alert hidden"></div>
            </div>
            
            <div class="card">
                <h2>Daftar Karyawan</h2>
                <table id="karyawanTable">
                    <thead>
                        <tr>
                            <th>Nama Karyawan</th>
                            <th>Email</th>
                            <th>Role</th>
                        </tr>
                    </thead>
                    <tbody id="karyawanTableBody">
                        <!-- Data karyawan akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Halaman Pemesanan -->
        <div id="orderPage" class="page">
            <h1>Pemesanan Barang</h1>
            <div class="card">
                <h2>Form Pemesanan</h2>
                <form id="orderForm">
                    <div class="form-group">
                        <label for="warungSelect">Pilih Warung</label>
                        <select id="warungSelect" required>
                            <option value="">Pilih Warung</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="karyawanSelect">Pilih Karyawan</label>
                        <select id="karyawanSelect" required>
                            <option value="">Pilih Karyawan</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="diskonOrder">Diskon (%)</label>
                        <input type="number" id="diskonOrder" min="0" max="100" value="0">
                    </div>
                    
                    <h3>Detail Pesanan</h3>
                    <div id="orderItems">
                        <div class="order-item">
                            <select class="barcodeSelect" required>
                                <option value="">Pilih Barcode</option>
                            </select>
                            <input type="text" class="namaBarang" placeholder="Nama Barang" readonly>
                            <input type="number" class="hargaBarang" placeholder="Harga" readonly>
                            <input type="number" class="qtyBarang" placeholder="Qty" min="1" value="1">
                            <input type="number" class="diskonBarang" placeholder="Diskon %" min="0" max="100" value="0">
                            <input type="text" class="totalBarang" placeholder="Total" readonly>
                            <button type="button" class="remove-btn btn-danger">×</button>
                        </div>
                    </div>
                    
                    <button type="button" id="addItemBtn">Tambah Item</button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="totalOrder">Total Pesanan</label>
                        <input type="text" id="totalOrder" readonly>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="submit" class="btn-success">Simpan Pesanan</button>
                        <button type="button" id="printOrderBtn" class="btn-warning">Cetak Pesanan (PDF)</button>
                        <button type="button" id="exportOrderBtn" class="btn-success">Export Pesanan (Excel)</button>
                    </div>
                </form>
                <div id="orderMessage" class="alert hidden"></div>
            </div>
        </div>

        <!-- Halaman Laporan -->
        <div id="laporanPage" class="page">
            <h1>Laporan</h1>
            <div class="card">
                <h2>Cetak Laporan</h2>
                <div class="print-options">
                    <button id="printStockReportBtn" class="btn-success">Cetak Stok (Excel)</button>
                    <button id="printOrderReportBtn" class="btn-success">Cetak Pesanan (Excel)</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Riwayat Pesanan</h2>
                <table id="orderHistoryTable">
                    <thead>
                        <tr>
                            <th>No. Pesanan</th>
                            <th>Warung</th>
                            <th>Karyawan</th>
                            <th>Tanggal</th>
                            <th>Total</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="orderHistoryTableBody">
                        <!-- Riwayat pesanan akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi Supabase
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State aplikasi
        let currentUser = null;
        let products = [];
        let warungs = [];
        let karyawans = [];
        let orders = [];
        
        // Elemen DOM
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const stockPage = document.getElementById('stockPage');
        const warungPage = document.getElementById('warungPage');
        const karyawanPage = document.getElementById('karyawanPage');
        const orderPage = document.getElementById('orderPage');
        const laporanPage = document.getElementById('laporanPage');
        const mainHeader = document.getElementById('mainHeader');
        
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        
        const navLinks = document.querySelectorAll('.nav-link');
        
        // Fungsi untuk menampilkan halaman tertentu
        function showPage(pageId) {
            // Sembunyikan semua halaman
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Tampilkan halaman yang dipilih
            document.getElementById(pageId).classList.add('active');
            
            // Update navigasi aktif
            navLinks.forEach(link => {
                if (link.getAttribute('data-page') === pageId.replace('Page', '')) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
        
        // Event listener untuk navigasi
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page') + 'Page';
                showPage(page);
            });
        });
        
        // Fungsi untuk login
        async function login(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                updateUIAfterAuth();
                loadInitialData();
                showPage('dashboardPage');
                
                return { success: true };
            } catch (error) {
                return { success: false, message: error.message };
            }
        }
        
        // Fungsi untuk logout
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                updateUIAfterAuth();
                showPage('loginPage');
            } catch (error) {
                console.error('Error logging out:', error.message);
            }
        }
        
        // Fungsi untuk memperbarui UI setelah autentikasi
        function updateUIAfterAuth() {
            if (currentUser) {
                loginPage.classList.add('hidden');
                mainHeader.classList.remove('hidden');
                
                logoutBtn.classList.remove('hidden');
                userInfo.textContent = `Halo, ${currentUser.email}`;
                
                // Tampilkan semua halaman kecuali login
                document.querySelectorAll('.page').forEach(page => {
                    if (page.id !== 'loginPage') {
                        page.classList.remove('hidden');
                    }
                });
            } else {
                loginPage.classList.remove('hidden');
                mainHeader.classList.add('hidden');
                
                logoutBtn.classList.add('hidden');
                userInfo.textContent = '';
                
                // Sembunyikan semua halaman kecuali login
                document.querySelectorAll('.page').forEach(page => {
                    if (page.id !== 'loginPage') {
                        page.classList.add('hidden');
                    }
                });
            }
        }
        
        // Event listener untuk form login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const result = await login(email, password);
            
            const loginMessage = document.getElementById('loginMessage');
            if (result.success) {
                loginMessage.textContent = 'Login berhasil!';
                loginMessage.className = 'alert alert-success';
            } else {
                loginMessage.textContent = result.message;
                loginMessage.className = 'alert alert-danger';
            }
            loginMessage.classList.remove('hidden');
        });
        
        // Event listener untuk logout
        logoutBtn.addEventListener('click', logout);
        
        // Fungsi untuk memuat data awal
        async function loadInitialData() {
            await Promise.all([
                loadProducts(),
                loadWarungs(),
                loadKaryawans(),
                loadOrders()
            ]);
            
            updateDashboard();
            populateWarungSelect();
            populateKaryawanSelect();
            populateBarcodeSelect();
            loadOrderHistory();
        }
        
        // Fungsi untuk memuat data produk
        async function loadProducts() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*');
                
                if (error) throw error;
                
                products = data || [];
                renderStockTable();
            } catch (error) {
                console.error('Error loading products:', error.message);
            }
        }
        
        // Fungsi untuk memuat data warung
        async function loadWarungs() {
            try {
                const { data, error } = await supabase
                    .from('warungs')
                    .select('*');
                
                if (error) throw error;
                
                warungs = data || [];
                renderWarungTable();
            } catch (error) {
                console.error('Error loading warungs:', error.message);
            }
        }
        
        // Fungsi untuk memuat data karyawan
        async function loadKaryawans() {
            try {
                const { data, error } = await supabase
                    .from('karyawans')
                    .select('*');
                
                if (error) throw error;
                
                karyawans = data || [];
                renderKaryawanTable();
            } catch (error) {
                console.error('Error loading karyawans:', error.message);
            }
        }
        
        // Fungsi untuk memuat data pesanan
        async function loadOrders() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        warungs(nama_warung, telp, alamat),
                        karyawans(nama_karyawan)
                    `);
                
                if (error) throw error;
                
                orders = data || [];
            } catch (error) {
                console.error('Error loading orders:', error.message);
            }
        }
        
        // Fungsi untuk memperbarui dashboard
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalWarungs').textContent = warungs.length;
            document.getElementById('totalKaryawans').textContent = karyawans.length;
            document.getElementById('totalOrders').textContent = orders.length;
        }
        
        // Fungsi untuk merender tabel stok
        function renderStockTable() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.barcode}</td>
                    <td>${product.nama_barang}</td>
                    <td>${product.stok}</td>
                    <td>${formatCurrency(product.harga)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Fungsi untuk merender tabel warung
        function renderWarungTable() {
            const tbody = document.getElementById('warungTableBody');
            tbody.innerHTML = '';
            
            warungs.forEach(warung => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${warung.nama_warung}</td>
                    <td>${warung.telp}</td>
                    <td>${warung.alamat}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Fungsi untuk merender tabel karyawan
        function renderKaryawanTable() {
            const tbody = document.getElementById('karyawanTableBody');
            tbody.innerHTML = '';
            
            karyawans.forEach(karyawan => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${karyawan.nama_karyawan}</td>
                    <td>${karyawan.email}</td>
                    <td>${karyawan.role}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Fungsi untuk mengisi dropdown warung
        function populateWarungSelect() {
            const select = document.getElementById('warungSelect');
            select.innerHTML = '<option value="">Pilih Warung</option>';
            
            warungs.forEach(warung => {
                const option = document.createElement('option');
                option.value = warung.id;
                option.textContent = `${warung.nama_warung} - ${warung.telp}`;
                option.setAttribute('data-telp', warung.telp);
                option.setAttribute('data-alamat', warung.alamat);
                select.appendChild(option);
            });
        }
        
        // Fungsi untuk mengisi dropdown karyawan
        function populateKaryawanSelect() {
            const select = document.getElementById('karyawanSelect');
            select.innerHTML = '<option value="">Pilih Karyawan</option>';
            
            karyawans.forEach(karyawan => {
                const option = document.createElement('option');
                option.value = karyawan.id;
                option.textContent = karyawan.nama_karyawan;
                select.appendChild(option);
            });
        }
        
        // Fungsi untuk mengisi dropdown barcode
        function populateBarcodeSelect() {
            const selects = document.querySelectorAll('.barcodeSelect');
            
            selects.forEach(select => {
                select.innerHTML = '<option value="">Pilih Barcode</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.barcode;
                    option.textContent = product.barcode;
                    option.setAttribute('data-nama', product.nama_barang);
                    option.setAttribute('data-harga', product.harga);
                    option.setAttribute('data-diskon', product.diskon || 0);
                    select.appendChild(option);
                });
            });
        }
        
        // Fungsi untuk memuat riwayat pesanan
        function loadOrderHistory() {
            const tbody = document.getElementById('orderHistoryTableBody');
            tbody.innerHTML = '';
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.warungs.nama_warung}</td>
                    <td>${order.karyawans.nama_karyawan}</td>
                    <td>${new Date(order.created_at).toLocaleDateString('id-ID')}</td>
                    <td>${formatCurrency(order.total)}</td>
                    <td>
                        <button class="view-order-btn" data-id="${order.id}">Lihat</button>
                        <button class="print-order-pdf-btn" data-id="${order.id}">PDF</button>
                        <button class="export-order-excel-btn" data-id="${order.id}">Excel</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Event listener untuk tombol lihat pesanan
            document.querySelectorAll('.view-order-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.getAttribute('data-id');
                    viewOrder(orderId);
                });
            });
            
            // Event listener untuk tombol cetak pesanan PDF
            document.querySelectorAll('.print-order-pdf-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.getAttribute('data-id');
                    printOrderPDF(orderId);
                });
            });
            
            // Event listener untuk tombol export pesanan Excel
            document.querySelectorAll('.export-order-excel-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.getAttribute('data-id');
                    exportOrderExcel(orderId);
                });
            });
        }
        
        // Fungsi untuk melihat detail pesanan
        function viewOrder(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (order) {
                alert(`Detail Pesanan #${order.id}\nWarung: ${order.warungs.nama_warung}\nKaryawan: ${order.karyawans.nama_karyawan}\nTotal: ${formatCurrency(order.total)}`);
            }
        }
        
        // Fungsi untuk mencetak pesanan dalam format PDF
        function printOrderPDF(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (!order) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Judul
            doc.setFontSize(18);
            doc.text('INVOICE PESANAN', 105, 15, { align: 'center' });
            
            // Informasi pesanan
            doc.setFontSize(12);
            doc.text(`No. Pesanan: ${order.id}`, 20, 30);
            doc.text(`Tanggal: ${new Date(order.created_at).toLocaleDateString('id-ID')}`, 20, 40);
            doc.text(`Warung: ${order.warungs.nama_warung}`, 20, 50);
            doc.text(`Telepon: ${order.warungs.telp}`, 20, 60);
            doc.text(`Alamat: ${order.warungs.alamat}`, 20, 70);
            doc.text(`Karyawan: ${order.karyawans.nama_karyawan}`, 20, 80);
            
            // Header tabel
            const headers = [['Barcode', 'Nama Barang', 'Harga', 'Qty', 'Diskon', 'Total']];
            const data = order.items.map(item => [
                item.barcode,
                item.nama_barang,
                formatCurrency(item.harga),
                item.qty,
                `${item.diskon}%`,
                formatCurrency(item.total)
            ]);
            
            // Tambahkan total
            data.push(['', '', '', '', 'Total:', formatCurrency(order.total)]);
            
            // Buat tabel
            doc.autoTable({
                startY: 90,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [52, 152, 219] }
            });
            
            // Simpan PDF
            doc.save(`pesanan_${order.id}.pdf`);
        }
        
        // Fungsi untuk export pesanan ke Excel
        function exportOrderExcel(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (!order) return;
            
            // Data untuk Excel
            const data = [
                ['INVOICE PESANAN'],
                [''],
                ['No. Pesanan:', order.id],
                ['Tanggal:', new Date(order.created_at).toLocaleDateString('id-ID')],
                ['Warung:', order.warungs.nama_warung],
                ['Telepon:', order.warungs.telp],
                ['Alamat:', order.warungs.alamat],
                ['Karyawan:', order.karyawans.nama_karyawan],
                [''],
                ['Barcode', 'Nama Barang', 'Harga', 'Qty', 'Diskon', 'Total']
            ];
            
            // Tambahkan item
            order.items.forEach(item => {
                data.push([
                    item.barcode,
                    item.nama_barang,
                    item.harga,
                    item.qty,
                    item.diskon,
                    item.total
                ]);
            });
            
            // Tambahkan total
            data.push(['', '', '', '', 'Total:', order.total]);
            
            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pesanan');
            
            // Simpan file
            XLSX.writeFile(wb, `pesanan_${order.id}.xlsx`);
        }
        
        // Fungsi untuk memformat mata uang
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR'
            }).format(amount);
        }
        
        // Event listener untuk upload area
        document.querySelectorAll('.upload-area').forEach(area => {
            area.addEventListener('click', () => {
                const fileInput = area.querySelector('input[type="file"]');
                fileInput.click();
            });
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.style.borderColor = '#3498db';
            });
            
            area.addEventListener('dragleave', () => {
                area.style.borderColor = '#ddd';
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.style.borderColor = '#ddd';
                
                const fileInput = area.querySelector('input[type="file"]');
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                }
            });
        });
        
        // Event listener untuk menambah item pesanan
        document.getElementById('addItemBtn').addEventListener('click', () => {
            const orderItems = document.getElementById('orderItems');
            const newItem = document.createElement('div');
            newItem.className = 'order-item';
            newItem.innerHTML = `
                <select class="barcodeSelect" required>
                    <option value="">Pilih Barcode</option>
                </select>
                <input type="text" class="namaBarang" placeholder="Nama Barang" readonly>
                <input type="number" class="hargaBarang" placeholder="Harga" readonly>
                <input type="number" class="qtyBarang" placeholder="Qty" min="1" value="1">
                <input type="number" class="diskonBarang" placeholder="Diskon %" min="0" max="100" value="0">
                <input type="text" class="totalBarang" placeholder="Total" readonly>
                <button type="button" class="remove-btn btn-danger">×</button>
            `;
            orderItems.appendChild(newItem);
            
            // Isi dropdown barcode untuk item baru
            populateBarcodeSelect();
            
            // Event listener untuk menghapus item
            newItem.querySelector('.remove-btn').addEventListener('click', () => {
                newItem.remove();
                calculateOrderTotal();
            });
            
            // Event listener untuk perubahan pada item
            const barcodeSelect = newItem.querySelector('.barcodeSelect');
            const qtyInput = newItem.querySelector('.qtyBarang');
            const diskonInput = newItem.querySelector('.diskonBarang');
            
            barcodeSelect.addEventListener('change', updateItemDetails);
            qtyInput.addEventListener('input', updateItemTotal);
            diskonInput.addEventListener('input', updateItemTotal);
        });
        
        // Fungsi untuk memperbarui detail item
        function updateItemDetails(e) {
            const select = e.target;
            const item = select.closest('.order-item');
            const namaBarang = item.querySelector('.namaBarang');
            const hargaBarang = item.querySelector('.hargaBarang');
            const diskonBarang = item.querySelector('.diskonBarang');
            
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption.value) {
                namaBarang.value = selectedOption.getAttribute('data-nama');
                hargaBarang.value = selectedOption.getAttribute('data-harga');
                
                // Otomatis isi diskon dari data produk
                const diskonProduk = selectedOption.getAttribute('data-diskon');
                if (diskonProduk && diskonProduk > 0) {
                    diskonBarang.value = diskonProduk;
                }
                
                updateItemTotal(null, item);
            } else {
                namaBarang.value = '';
                hargaBarang.value = '';
                diskonBarang.value = '0';
                item.querySelector('.totalBarang').value = '';
            }
        }
        
        // Fungsi untuk memperbarui total item
        function updateItemTotal(e, itemElement = null) {
            const item = itemElement || (e ? e.target.closest('.order-item') : null);
            if (!item) return;
            
            const harga = parseFloat(item.querySelector('.hargaBarang').value) || 0;
            const qty = parseInt(item.querySelector('.qtyBarang').value) || 0;
            const diskon = parseFloat(item.querySelector('.diskonBarang').value) || 0;
            
            const subtotal = harga * qty;
            const total = subtotal - (subtotal * diskon / 100);
            
            item.querySelector('.totalBarang').value = formatCurrency(total);
            
            calculateOrderTotal();
        }
        
        // Fungsi untuk menghitung total pesanan
        function calculateOrderTotal() {
            const items = document.querySelectorAll('.order-item');
            let subtotal = 0;
            
            items.forEach(item => {
                const totalBarang = item.querySelector('.totalBarang').value;
                if (totalBarang) {
                    const numericValue = parseFloat(totalBarang.replace(/[^\d,-]/g, '').replace(',', '.'));
                    subtotal += isNaN(numericValue) ? 0 : numericValue;
                }
            });
            
            const diskonOrder = parseFloat(document.getElementById('diskonOrder').value) || 0;
            const total = subtotal - (subtotal * diskonOrder / 100);
            
            document.getElementById('totalOrder').value = formatCurrency(total);
        }
        
        // Event listener untuk perubahan diskon pesanan
        document.getElementById('diskonOrder').addEventListener('input', calculateOrderTotal);
        
        // Event listener untuk form pesanan
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const warungId = document.getElementById('warungSelect').value;
            const karyawanId = document.getElementById('karyawanSelect').value;
            const diskonOrder = parseFloat(document.getElementById('diskonOrder').value) || 0;
            
            const items = [];
            let isValid = true;
            
            document.querySelectorAll('.order-item').forEach(item => {
                const barcode = item.querySelector('.barcodeSelect').value;
                const namaBarang = item.querySelector('.namaBarang').value;
                const harga = parseFloat(item.querySelector('.hargaBarang').value) || 0;
                const qty = parseInt(item.querySelector('.qtyBarang').value) || 0;
                const diskon = parseFloat(item.querySelector('.diskonBarang').value) || 0;
                const total = parseFloat(item.querySelector('.totalBarang').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
                
                if (barcode && namaBarang && harga > 0 && qty > 0) {
                    items.push({
                        barcode,
                        nama_barang: namaBarang,
                        harga,
                        qty,
                        diskon,
                        total
                    });
                } else if (barcode || namaBarang || harga > 0 || qty > 0) {
                    isValid = false;
                }
            });
            
            if (!warungId || !karyawanId || items.length === 0 || !isValid) {
                showMessage('orderMessage', 'Harap isi semua field dengan benar', 'danger');
                return;
            }
            
            const totalOrder = parseFloat(document.getElementById('totalOrder').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .insert([
                        {
                            warung_id: warungId,
                            karyawan_id: karyawanId,
                            diskon: diskonOrder,
                            items: items,
                            total: totalOrder
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                showMessage('orderMessage', 'Pesanan berhasil disimpan!', 'success');
                document.getElementById('orderForm').reset();
                document.getElementById('orderItems').innerHTML = `
                    <div class="order-item">
                        <select class="barcodeSelect" required>
                            <option value="">Pilih Barcode</option>
                        </select>
                        <input type="text" class="namaBarang" placeholder="Nama Barang" readonly>
                        <input type="number" class="hargaBarang" placeholder="Harga" readonly>
                        <input type="number" class="qtyBarang" placeholder="Qty" min="1" value="1">
                        <input type="number" class="diskonBarang" placeholder="Diskon %" min="0" max="100" value="0">
                        <input type="text" class="totalBarang" placeholder="Total" readonly>
                        <button type="button" class="remove-btn btn-danger">×</button>
                    </div>
                `;
                
                populateBarcodeSelect();
                await loadOrders();
                loadOrderHistory();
                updateDashboard();
                
            } catch (error) {
                console.error('Error saving order:', error.message);
                showMessage('orderMessage', 'Gagal menyimpan pesanan: ' + error.message, 'danger');
            }
        });
        
        // Event listener untuk tombol cetak pesanan PDF
        document.getElementById('printOrderBtn').addEventListener('click', () => {
            const warungSelect = document.getElementById('warungSelect');
            const karyawanSelect = document.getElementById('karyawanSelect');
            const diskonOrder = document.getElementById('diskonOrder').value;
            const totalOrder = document.getElementById('totalOrder').value;
            
            const warungText = warungSelect.options[warungSelect.selectedIndex]?.text || '';
            const karyawanText = karyawanSelect.options[karyawanSelect.selectedIndex]?.text || '';
            
            const items = [];
            document.querySelectorAll('.order-item').forEach(item => {
                const barcode = item.querySelector('.barcodeSelect').value;
                const namaBarang = item.querySelector('.namaBarang').value;
                const harga = item.querySelector('.hargaBarang').value;
                const qty = item.querySelector('.qtyBarang').value;
                const diskon = item.querySelector('.diskonBarang').value;
                const total = item.querySelector('.totalBarang').value;
                
                if (barcode && namaBarang) {
                    items.push({
                        barcode,
                        nama_barang: namaBarang,
                        harga,
                        qty,
                        diskon,
                        total
                    });
                }
            });
            
            if (items.length === 0) {
                alert('Tidak ada item untuk dicetak');
                return;
            }
            
            // Buat PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Judul
            doc.setFontSize(18);
            doc.text('FORM PESANAN', 105, 15, { align: 'center' });
            
            // Informasi pesanan
            doc.setFontSize(12);
            doc.text(`Warung: ${warungText}`, 20, 30);
            doc.text(`Karyawan: ${karyawanText}`, 20, 40);
            doc.text(`Diskon: ${diskonOrder}%`, 20, 50);
            
            // Header tabel
            const headers = [['Barcode', 'Nama Barang', 'Harga', 'Qty', 'Diskon', 'Total']];
            const data = items.map(item => [
                item.barcode,
                item.nama_barang,
                item.harga,
                item.qty,
                `${item.diskon}%`,
                item.total
            ]);
            
            // Tambahkan total
            data.push(['', '', '', '', 'Total:', totalOrder]);
            
            // Buat tabel
            doc.autoTable({
                startY: 60,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [52, 152, 219] }
            });
            
            // Simpan PDF
            doc.save('form_pesanan.pdf');
        });
        
        // Event listener untuk tombol export pesanan Excel
        document.getElementById('exportOrderBtn').addEventListener('click', () => {
            const warungSelect = document.getElementById('warungSelect');
            const karyawanSelect = document.getElementById('karyawanSelect');
            const diskonOrder = document.getElementById('diskonOrder').value;
            const totalOrder = document.getElementById('totalOrder').value;
            
            const warungText = warungSelect.options[warungSelect.selectedIndex]?.text || '';
            const karyawanText = karyawanSelect.options[karyawanSelect.selectedIndex]?.text || '';
            
            const items = [];
            document.querySelectorAll('.order-item').forEach(item => {
                const barcode = item.querySelector('.barcodeSelect').value;
                const namaBarang = item.querySelector('.namaBarang').value;
                const harga = item.querySelector('.hargaBarang').value;
                const qty = item.querySelector('.qtyBarang').value;
                const diskon = item.querySelector('.diskonBarang').value;
                const total = item.querySelector('.totalBarang').value;
                
                if (barcode && namaBarang) {
                    items.push({
                        barcode,
                        nama_barang: namaBarang,
                        harga: parseFloat(harga),
                        qty: parseInt(qty),
                        diskon: parseFloat(diskon),
                        total: parseFloat(total.replace(/[^\d,-]/g, '').replace(',', '.'))
                    });
                }
            });
            
            if (items.length === 0) {
                alert('Tidak ada item untuk diexport');
                return;
            }
            
            // Data untuk Excel
            const data = [
                ['FORM PESANAN'],
                [''],
                ['Warung:', warungText],
                ['Karyawan:', karyawanText],
                ['Diskon:', `${diskonOrder}%`],
                [''],
                ['Barcode', 'Nama Barang', 'Harga', 'Qty', 'Diskon', 'Total']
            ];
            
            // Tambahkan item
            items.forEach(item => {
                data.push([
                    item.barcode,
                    item.nama_barang,
                    item.harga,
                    item.qty,
                    item.diskon,
                    item.total
                ]);
            });
            
            // Tambahkan total
            const totalNumeric = parseFloat(totalOrder.replace(/[^\d,-]/g, '').replace(',', '.'));
            data.push(['', '', '', '', 'Total:', totalNumeric]);
            
            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pesanan');
            
            // Simpan file
            XLSX.writeFile(wb, 'form_pesanan.xlsx');
        });
        
        // Fungsi untuk menampilkan pesan
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `alert alert-${type}`;
            element.classList.remove('hidden');
            
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        
        // Event listener untuk tombol cetak stok
        document.getElementById('printStockBtn').addEventListener('click', () => {
            // Data untuk Excel
            const data = [
                ['LAPORAN STOK BARANG'],
                [''],
                ['Barcode', 'Nama Barang', 'Stok', 'Harga']
            ];
            
            // Tambahkan data produk
            products.forEach(product => {
                data.push([
                    product.barcode,
                    product.nama_barang,
                    product.stok,
                    product.harga
                ]);
            });
            
            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Stok Barang');
            
            // Simpan file
            XLSX.writeFile(wb, 'laporan_stok.xlsx');
        });
        
        // Event listener untuk tombol cetak laporan stok
        document.getElementById('printStockReportBtn').addEventListener('click', () => {
            // Data untuk Excel
            const data = [
                ['LAPORAN STOK BARANG'],
                [''],
                ['Barcode', 'Nama Barang', 'Stok', 'Harga']
            ];
            
            // Tambahkan data produk
            products.forEach(product => {
                data.push([
                    product.barcode,
                    product.nama_barang,
                    product.stok,
                    product.harga
                ]);
            });
            
            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Stok Barang');
            
            // Simpan file
            XLSX.writeFile(wb, 'laporan_stok.xlsx');
        });
        
        // Event listener untuk tombol cetak laporan pesanan
        document.getElementById('printOrderReportBtn').addEventListener('click', () => {
            // Data untuk Excel
            const data = [
                ['LAPORAN PESANAN'],
                [''],
                ['ID Pesanan', 'Warung', 'Karyawan', 'Tanggal', 'Total']
            ];
            
            // Tambahkan data pesanan
            orders.forEach(order => {
                data.push([
                    order.id,
                    order.warungs.nama_warung,
                    order.karyawans.nama_karyawan,
                    new Date(order.created_at).toLocaleDateString('id-ID'),
                    order.total
                ]);
            });
            
            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pesanan');
            
            // Simpan file
            XLSX.writeFile(wb, 'laporan_pesanan.xlsx');
        });
        
        // Inisialisasi aplikasi
        document.addEventListener('DOMContentLoaded', () => {
            // Cek status autentikasi saat aplikasi dimuat
            supabase.auth.getUser().then(({ data: { user } }) => {
                if (user) {
                    currentUser = user;
                    updateUIAfterAuth();
                    loadInitialData();
                    showPage('dashboardPage');
                } else {
                    updateUIAfterAuth();
                }
            });
        });
    </script>
</body>
</html>
